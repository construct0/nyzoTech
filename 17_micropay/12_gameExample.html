<link rel="stylesheet" type="text/css" href="../style.css">

<h1>Game example</h1>

<p class="emphasis">
    This page requires version 5 or later of the Chrome extension to demonstrate full functionality.
</p>

<p>
    The previous example has been moved to the <a href="automaticTransactionExample">Micropay automatic transaction
    example</a> page. This page will build upon that example to demonstrate gaming with Nyzo.
</p>

<p>
    This page currently shows an interactive board. Clicks on the board place X's and O's alternately until a winner is
    determined or stalemate is reached. Transactions are not yet generated.
</p>

<style>
    .board {
        display: table;
        margin: auto;
        border-radius: 0.4rem;
    }
    .board-win {
        background-color: rgba(128, 255, 128, 0.4);
    }
    .board > div {
        display: table-row;
    }
    .board > div > div {
        display: table-cell;
        text-align: center;
        font-size: 1.4rem;
        font-weight: bold;
        border-right: 3px solid black;
        border-bottom: 3px solid black;
        width: 2.4rem;
        height: 2.4rem;
    }
    .board > div:nth-child(2) > div:nth-child(2) {
        width: 2.6rem;
        height: 2.5rem;
    }
    .board > div > div > div {
        height: 1rem;
    }
    .board > div:last-child > div {
        border-bottom: none;
    }
    .board > div > div:last-child {
        border-right: none;
    }

    .sub-x {
        user-select: none;
    }
    .sub-o {
        position: relative;
        top: -0.57rem;
        user-select: none;
    }
    .x .sub-x {
        visibility: visible;
    }
    .x .sub-o {
        visibility: hidden;
    }
    .o .sub-x {
        visibility: hidden;
    }
    .o .sub-o {
        visibility: visible;
    }
    .empty > div {
        visibility: hidden;
    }
</style>

<div id="board" class="board">
    <div>
        <div id="cell-0" onclick="cellClick(this)"><div class="sub-x">&#x2573;</div><div class="sub-o">&xcirc;</div></div>
        <div id="cell-1" onclick="cellClick(this)"><div class="sub-x">&#x2573;</div><div class="sub-o">&xcirc;</div></div>
        <div id="cell-2" onclick="cellClick(this)"><div class="sub-x">&#x2573;</div><div class="sub-o">&xcirc;</div></div>
    </div>
    <div>
        <div id="cell-3" onclick="cellClick(this)"><div class="sub-x">&#x2573;</div><div class="sub-o">&xcirc;</div></div>
        <div id="cell-4" onclick="cellClick(this)"><div class="sub-x">&#x2573;</div><div class="sub-o">&xcirc;</div></div>
        <div id="cell-5" onclick="cellClick(this)"><div class="sub-x">&#x2573;</div><div class="sub-o">&xcirc;</div></div>
    </div>
    <div>
        <div id="cell-6" onclick="cellClick(this)"><div class="sub-x">&#x2573;</div><div class="sub-o">&xcirc;</div></div>
        <div id="cell-7" onclick="cellClick(this)"><div class="sub-x">&#x2573;</div><div class="sub-o">&xcirc;</div></div>
        <div id="cell-8" onclick="cellClick(this)"><div class="sub-x">&#x2573;</div><div class="sub-o">&xcirc;</div></div>
    </div>
</div>

<script>

    let state = '---------';

    function cellClick(cell) {
        // Determine the index. Only respond for an empty cell.
        let index = parseInt(cell.id.substring(5));
        if (state[index] == '-') {
            // Place the appropriate letter at the appropriate position to build the next state.
            let play = count(state, 'X') > count(state, 'O') ? 'O' : 'X';
            let nextState = state.substring(0, index) + play + state.substring(index + 1);

            // If the next state is valid, replace the current state with the next state.
            if (isValidNextState(nextState, state)) {
                state = nextState;
                configureBoardForState(state);
            }
        }
    }

    function configureBoardForState(state) {
        for (let i = 0; i < 9; i++) {
            let div = document.getElementById('cell-' + i);
            if (state[i] == 'X') {
                div.className = 'x';
            } else if (state[i] == 'O') {
                div.className = 'o';
            } else {
                div.className = 'empty';
            }
        }

        document.getElementById('board').className = isWinningState(state) ? 'board board-win' : 'board';
    }

    function isValidNextState(nextState, currentState) {
        // Only check further if the current state is not a winning state.
        let isValidNextState = false;
        if (!isWinningState(currentState)) {
            let currentXCount = count(currentState, 'X');
            let currentOCount = count(currentState, 'O');
            let nextXCount = count(nextState, 'X');
            let nextOCount = count(nextState, 'O');

            // The number of Xs should always be the same or one greater than the number of Os. Either the board should
            // be balanced and move to a +1X imbalance, or it should be a +1X imbalance and move to balanced.
            let toPlusOneX = (currentXCount == currentOCount && nextXCount == (currentXCount + 1) &&
                nextOCount == currentOCount);
            let toBalanced = (nextXCount == nextOCount && nextXCount == currentXCount &&
                nextOCount == (currentOCount + 1));
            if (toPlusOneX || toBalanced) {
                // Check the number of board differences. Exactly one is required.
                let numberOfDifferences = 0;
                for (let i = 0; i < 9; i++) {
                    if (currentState[i] != nextState[i]) {
                        numberOfDifferences++;
                    }
                }
                isValidNextState = numberOfDifferences == 1;
            }
        }

        return isValidNextState;
    }

    function isWinningState(state) {
        return (state[0] != '-' && (state[0] == state[1] && state[1] == state[2])) ||   // top
            (state[0] != '-' && (state[0] == state[3] && state[3] == state[6])) ||      // left
            (state[2] != '-' && (state[2] == state[5] && state[5] == state[8])) ||      // right
            (state[6] != '-' && (state[6] == state[7] && state[7] == state[8])) ||      // bottom
            (state[0] != '-' && (state[0] == state[4] && state[4] == state[8])) ||      // left diagonal
            (state[2] != '-' && (state[2] == state[4] && state[4] == state[6])) ||      // right diagonal
            (state[3] != '-' && (state[3] == state[4] && state[4] == state[5])) ||      // middle horizontal
            (state[1] != '-' && (state[1] == state[4] && state[4] == state[7]));        // middle vertical
    }

    function isValidState(state) {
        // The number of Xs and Os must be the same, or the number of Xs should be one greater than the number of Os.
        let xCount = count(state, 'X');
        let oCount = count(state, 'O');

        return xCount == oCount || xCount == (oCount + 1);
    }

    function count(state, character) {
        let count = 0;
        for (let i = 0; i < 9; i++) {
            if (state[i] == character) {
                count++;
            }
        }

        return count;
    }

    configureBoardForState(state);
</script>

<p class="italic">
    This page is under active development as a demonstration of the process for building applications on Nyzo.
</p>