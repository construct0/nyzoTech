<link rel="stylesheet" type="text/css" href="../style.css">

<h1>Vault example</h1>

<p>
    In addition to purchasing content and running applications, Micropay can be used to establish provenance of digital
    material.
</p>

<p>
    The initial implementation will consist of two pieces of information:
</p>

<ul>
    <li>URL of the material</li>
    <li>content of the material</li>
</ul>

<p>
    The system will need two elements to be useful:
</p>

<ul>
    <li>a method for registration</li>
    <li>a method for confirmation</li>
</ul>

<div class="form">
    <div class="form-input-container">
        <div class="form-label">asset URL</div>
        <input class="form-input" id="asset-url">
    </div>

    <div class="form-input-container">
        <input class="form-submit" type="submit" value="generate transaction" onclick="generateButtonClick()">
    </div>
</div>

<p class="form" id="result" style="margin-top: 1rem; padding: 1rem;">
    When the <span class="italic">generate transaction</span> button is clicked, the asset at the specified URL will be
    fetched, and the result of the fetch will be displayed here. Transaction information is not yet generated.
</p>

<div class="nyzo-micropay-button nyzo-extension-not-installed"
     id="micropay-button"
     data-client-url="https://client.nyzo.co/api/forwardTransaction"
     data-receiver-id="id__8cdasPC2QVZ13iG42RWhp47gow9SsIXZgp0Aga59oEITG2X-M7Ur"
     data-display-name="Register content"
     data-tag=""
     data-amount="0.0">
</div>

<p class="italic">
    This page is in active development to demonstrate registration of digital goods on the Nyzo blockchain.
</p>

<script src="sha256.js"></script>
<script src="micropayUtil.js"></script>
<script>
    function generateButtonClick() {
        // Try to get the contents of the asset URL. Checking the URL is not necessary, and even a good URL would not
        // necessarily be accessible. Only check if the URL is not the empty string, because that would just fetch this
        // page.
        const url = document.getElementById('asset-url').value.trim();
        if (url.length > 0) {
            fetch(url)
                .then(response => response.status == 200 && response.arrayBuffer())
                .then(buffer => {
                    const result = document.getElementById('result');
                    const micropayButton = document.getElementById('micropay-button');
                    if (buffer && buffer.byteLength > 0) {
                        const urlBytes = stringAsUint8Array(url);
                        const assetBytes = new Uint8Array(buffer);
                        const combinedArray = new Uint8Array(urlBytes.length + assetBytes.length);
                        combinedArray.set(urlBytes, 0);
                        combinedArray.set(assetBytes, urlBytes.length);
                        const hash = doubleSha256(combinedArray);
                        result.innerHTML = 'A buffer of length ' + buffer.byteLength +
                            ' was fetched from <span class="italic">' + addBreaks(url) + '</span>.<br><br>' +
                            'The double SHA-256 hash of the combined URL and asset is <span class="italic">' +
                            uint8ArrayAsHexString(hash, true, true) + '</span>.';

                        micropayButton.dataset.tag = hash;
                        micropayButton.dataset.amount = 0.01;
                    } else {
                        result.innerHTML = 'Unable to fetch contents of <span class="italic">' + addBreaks(url) +
                            '</span>';
                        micropayButton.dataset.tag = '';
                        micropayButton.dataset.amount = 0.0;
                    }

                    // Dispatch an event to notify the extension that the configuration has changed.
                    const event = new Event('nyzo-configuration-changed');
                    document.dispatchEvent(event);
                })
                .catch(function (error) {
                    result.innerHTML = 'Unable to fetch contents of <span class="italic">' + addBreaks(url) + '</span>';
                });
        }
    }

    function addBreaks(url) {
        let result = '';
        for (let i = 0; i < url.length - 1; i++) {
            if (url[i] == '/' && url[i + 1] != '/') {
                result += '/<wbr>';
            } else {
                result += url[i];
            }
        }
        if (url.length > 0) {
            result += url[url.length - 1];
        }

        return result;
    }
</script>